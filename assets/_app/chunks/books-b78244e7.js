import{C as t,Q as e,R as s,T as n,U as o}from"./vendor-83b66aae.js";class r{constructor(s,n,o=5e3){this.initialized=!1,this.changeFns=[],this.name=s,this.store=t(n),this.init(),this.debouncedPersist=e.debounce(this.persist,o)}async init(){const t=await s.getItem({key:this.name})();if(t)try{this.store.set(this.fromString(t))}catch(o){console.error(o)}const e=this.changeFns.slice();this.changeFns.length=0,e.forEach((t=>this.store.update((e=>n.change(e,t))))),this.debouncedPersist(),this.initialized=!0}async persist(){await s.setItem({key:this.name,value:this.toString()})()}get(){return o(this.store)}change(t){return this.initialized?(this.store.update((e=>n.change(e,t))),this.debouncedPersist()):this.changeFns.push(t),this}subscribe(t,e){return this.store.subscribe(t,e)}toString(){return function(t){return t.reduce(((t,e)=>t+e.toString(16).padStart(2,"0")),"")}(n.save(this.get()))}fromString(t){const e=function(t){const e=[];for(let n=0;n<t.length;n+=2)e.push(parseInt(t.substr(n,2),16));const s=new Uint8Array(e);return s.__binaryDocument=!0,s}(t);return n.load(e)}}var i,a;function c(t,e){const s={type:e,index:0,createdAt:(new Date).toJSON()};var o;null!==(o=s)&&"object"==typeof o&&o.type===i.Text&&(s.text=new n.Text),d.getBookById(t).change((t=>{s.index=t.blocks.rows.reduce(((t,e)=>t>e.index?t:e.index+1),0),t.blocks.add(s)}))}function h(t,e,s){d.getBookById(t).change((t=>{const n=t.blocks.byId(e);n&&s(n)}))}function u(t){return`book-${t}`}(i||(i={})).Text="text",(a||(a={})).Journel="journel";const d=new class extends r{constructor(){super(...arguments),this.bookStores={}}createBook(t,e){let s;this.change((o=>{const r=(new Date).toJSON();s=o.metas.add({name:new n.Text(t),type:e,createdAt:r})}));const o=new r(u(s),n.from({bookMetaId:s,blocks:new n.Table}));return this.bookStores[s]=o,o}getBookById(t){const e=this.bookStores[t];if(e)return e;{const e=new r(u(t),n.from({bookMetaId:t,name:new n.Text,createdAt:(new Date).toJSON(),blocks:new n.Table}));return this.bookStores[t]=e,e}}unloadBookById(t){return delete this.bookStores[t],this}}("books",n.from({metas:new n.Table}));export{a as B,i as a,d as b,c,h as u};
